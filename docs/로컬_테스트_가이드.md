# ë¡œì»¬ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì • ê°€ì´ë“œ

## ğŸ“‹ í•„ìˆ˜ ì¤€ë¹„ì‚¬í•­

### 1. ì¸í”„ë¼ ì„œë¹„ìŠ¤ ì‹¤í–‰

```bash
# í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ
cd infra

# PostgreSQL, Redis, LiveKit ì‹œì‘
docker-compose -f docker-compose-infra.yaml up -d

# ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
docker-compose -f docker-compose-infra.yaml ps
```

**ì‹¤í–‰ë˜ì–´ì•¼ í•  ì„œë¹„ìŠ¤:**
- PostgreSQL (í¬íŠ¸: 8432)
- Redis (í¬íŠ¸: 6379)
- LiveKit (í¬íŠ¸: 7880, 7881, 7882)

---

### 2. ë°±ì—”ë“œ í™˜ê²½ë³€ìˆ˜ ì„¤ì •

í”„ë¡œì íŠ¸ ë£¨íŠ¸ì˜ `.env` íŒŒì¼ í™•ì¸:

```bash
# ë°ì´í„°ë² ì´ìŠ¤
DB_URL=jdbc:postgresql://localhost:8432/hearo_db?ssl=false
DB_USER=postgres
DB_PASSWORD=1234

# Redis
REDIS_PASSWORD=ssafy_redis_1234!
REDIS_HOST=localhost
REDIS_PORT=6379

# LiveKit
LIVEKIT_URL=ws://localhost:7880
LIVEKIT_API_KEY=devkey
LIVEKIT_API_SECRET=my_super_long_secret_key_for_ssafy_project_1234556789

# Spring í”„ë¡œí•„
SPRING_PROFILES_ACTIVE=dev
```

---

### 3. ë°±ì—”ë“œ ì‹¤í–‰

```bash
cd backend

# Gradle ë¹Œë“œ ë° ì‹¤í–‰
./gradlew bootRun

# ë˜ëŠ” IDEì—ì„œ HearoApplication.java ì‹¤í–‰
```

**í™•ì¸ì‚¬í•­:**
- ì„œë²„ ì‹œì‘: `http://localhost:8080`
- Swagger UI: `http://localhost:8080/swagger-ui.html`
- WebSocket ì—”ë“œí¬ì¸íŠ¸: `ws://localhost:8080/ws/queue`

---

### 4. í”„ë¡ íŠ¸ì—”ë“œ í™˜ê²½ë³€ìˆ˜ ì„¤ì •

`frontend/.env.local` íŒŒì¼ í™•ì¸:

```bash
# ë°±ì—”ë“œ API í”„ë¡ì‹œ
VITE_API_PROXY_TARGET=http://localhost:8080

# WebSocket Base URL (STOMP ì—°ê²°ìš©)
VITE_WS_BASE_URL=http://localhost:8080

# LiveKit ì„œë²„ URL
VITE_LIVEKIT_URL=ws://localhost:8880
```

---

### 5. í”„ë¡ íŠ¸ì—”ë“œ ì‹¤í–‰

```bash
cd frontend

# ì˜ì¡´ì„± ì„¤ì¹˜ (ìµœì´ˆ 1íšŒ)
npm install

# ê°œë°œ ì„œë²„ ì‹¤í–‰
npm run dev
```

**í™•ì¸ì‚¬í•­:**
- ì„œë²„ ì‹œì‘: `http://localhost:5173`
- HMR (Hot Module Replacement) í™œì„±í™”

---

## ğŸ§ª ë§¤ì¹­ ì•Œë¦¼ í…ŒìŠ¤íŠ¸ í”Œë¡œìš°

### 1. ì´ˆê¸° ë°ì´í„° ìƒì„±

ë°±ì—”ë“œì˜ `TestDataInit.java`ê°€ ìë™ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤:
- ê³ ê° 3ëª… (ID: 1, 2, 3)
- ìƒë‹´ì› 2ëª… (ID: 1, 2)

### 2. ê³ ê° ì ‘ìˆ˜ â†’ ëŒ€ê¸°ì—´ ì§„ì…

```bash
# ê³ ê° ì ‘ìˆ˜ API í˜¸ì¶œ (Postman/curl)
POST http://localhost:8080/api/v1/registrations
Content-Type: application/json

{
  "symptom": "ëƒ‰ì¥ê³ ê°€ ì•ˆ ì‹œì›í•´ìš”",
  "productId": 1,
  "errorCode": "E001",
  "manufacturedAt": "2025-01-01",
  "warrantyEndsAt": "2027-01-01"
}

# ëŒ€ê¸°ì—´ ì§„ì… API í˜¸ì¶œ
POST http://localhost:8080/api/v1/queue/enqueue
Content-Type: application/json

{
  "customerId": "1"
}
```

### 3. ìƒë‹´ì› ê°€ìš© ìƒíƒœ ì„¤ì •

```bash
# ìƒë‹´ì› ìƒíƒœë¥¼ "ê°€ìš©"ìœ¼ë¡œ ë³€ê²½
PUT http://localhost:8080/api/v1/counselors/1/availability
Content-Type: application/json

{
  "available": true
}
```

### 4. ìë™ ë§¤ì¹­ ëŒ€ê¸°

`MatchingScheduler`ê°€ 5ì´ˆë§ˆë‹¤ ìë™ìœ¼ë¡œ ë§¤ì¹­ì„ ì‹œë„í•©ë‹ˆë‹¤.

**ë§¤ì¹­ ì„±ê³µ ì‹œ ë¡œê·¸:**
```
[MatchingScheduler] ë§¤ì¹­ ì‹œì‘ - ê°€ìš© ìƒë‹´ì›: 1ëª…, ëŒ€ê¸° ê³ ê°: 1ëª…
[QueueEventPublisher] ê³ ê° ë§¤ì¹­ ì•Œë¦¼ ì „ì†¡: customerId=1, roomName=room-1-1-abc12345
[QueueEventPublisher] ìƒë‹´ì› ë§¤ì¹­ ì•Œë¦¼ ì „ì†¡: counselorId=1, roomName=room-1-1-abc12345
[MatchingScheduler] ë§¤ì¹­ ì™„ë£Œ: ê³ ê°=1, ìƒë‹´ì›=1, ë°©=room-1-1-abc12345
```

### 5. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ í™•ì¸

**ê³ ê° ëŒ€ê¸° í™”ë©´ (`/client/waiting`):**
1. STOMP ì—°ê²° ë¡œê·¸ í™•ì¸
   ```
   [STOMP] ì—°ê²° ì„±ê³µ
   [STOMP] ë§¤ì¹­ ì™„ë£Œ: { status: "MATCHED", roomName: "room-1-1-abc12345", identity: "customer_1" }
   ```

2. LiveKit í† í° ìš”ì²­
   ```
   [CallConnection] ë§¤ì¹­ ì™„ë£Œ, LiveKit í† í° ìš”ì²­ ì¤‘...
   POST /api/v1/calls/token
   ```

3. LiveKit ì—°ê²°
   ```
   [CallConnection] LiveKit ì—°ê²° ì¤‘...
   [LiveKit] ë£¸ ì—°ê²° ì„±ê³µ: room-1-1-abc12345
   [CallConnection] í†µí™” ì—°ê²° ì™„ë£Œ
   ```

4. ìë™ìœ¼ë¡œ `/client/call` í˜ì´ì§€ë¡œ ì´ë™

---

## ğŸ” ë””ë²„ê¹… ì²´í¬í¬ì¸íŠ¸

### WebSocket ì—°ê²° í™•ì¸

**Chrome DevTools > Network > WS íƒ­:**
- `ws://localhost:8080/ws/queue/...` ì—°ê²° í™•ì¸
- STOMP í”„ë ˆì„ í™•ì¸:
  ```
  CONNECT
  SUBSCRIBE destination:/topic/queue-rank/1
  MESSAGE
  ```

### ë°±ì—”ë“œ ë¡œê·¸ í™•ì¸

```bash
# ë§¤ì¹­ ìŠ¤ì¼€ì¤„ëŸ¬ ë¡œê·¸
grep "MatchingScheduler" backend/logs/application.log

# WebSocket ì´ë²¤íŠ¸ ë¡œê·¸
grep "QueueEventPublisher" backend/logs/application.log
```

### LiveKit ì—°ê²° í™•ì¸

LiveKit ì„œë²„ ë¡œê·¸:
```bash
docker logs livekit-server
```

---

## âš ï¸ ì¼ë°˜ì ì¸ ë¬¸ì œ í•´ê²°

### 1. WebSocket ì—°ê²° ì‹¤íŒ¨

**ì¦ìƒ:** `[STOMP] ì—°ê²° í•´ì œ` ë°˜ë³µ

**í•´ê²°:**
- ë°±ì—”ë“œê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
- CORS ì„¤ì • í™•ì¸ (WebSocketConfig.java)
- í¬íŠ¸ ì¶©ëŒ í™•ì¸ (8080)

### 2. ë§¤ì¹­ ì•Œë¦¼ì„ ë°›ì§€ ëª»í•¨

**ì¦ìƒ:** ëŒ€ê¸° í™”ë©´ì—ì„œ ê³„ì† ëŒ€ê¸° ì¤‘

**í•´ê²°:**
1. ìƒë‹´ì›ì´ ê°€ìš© ìƒíƒœì¸ì§€ í™•ì¸
   ```bash
   GET http://localhost:8080/api/v1/counselors/1/availability
   ```

2. ëŒ€ê¸°ì—´ì— ê³ ê°ì´ ìˆëŠ”ì§€ í™•ì¸
   ```bash
   GET http://localhost:8080/api/v1/queue/status
   ```

3. MatchingScheduler ë¡œê·¸ í™•ì¸
   ```
   ë§¤ì¹­ ìŠ¤í‚µ: ë§¤ì¹­ ê°€ëŠ¥í•œ ìƒë‹´ì› ì—†ìŒ
   ```

### 3. LiveKit í† í° ìš”ì²­ ì‹¤íŒ¨

**ì¦ìƒ:** `[CallConnection] ì—°ê²° ì‹¤íŒ¨: 401 Unauthorized`

**í•´ê²°:**
- `.env`ì˜ `LIVEKIT_API_KEY`, `LIVEKIT_API_SECRET` í™•ì¸
- LiveKit ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
  ```bash
  docker ps | grep livekit
  ```

### 4. LiveKit ì—°ê²° ì‹¤íŒ¨

**ì¦ìƒ:** `[LiveKit] ì—°ê²° ì‹¤íŒ¨: WebSocket connection failed`

**í•´ê²°:**
- LiveKit URL í™•ì¸ (`ws://localhost:7880`)
- ë°©í™”ë²½ í™•ì¸ (í¬íŠ¸ 7880-7882)
- LiveKit ì„œë²„ ì¬ì‹œì‘
  ```bash
  docker-compose -f docker-compose-infra.yaml restart livekit-server
  ```

---

## ğŸ“Š í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ì •ìƒ ë§¤ì¹­ í”Œë¡œìš°

1. ê³ ê° ì ‘ìˆ˜ (`POST /registrations`)
2. ëŒ€ê¸°ì—´ ì§„ì… (`POST /queue/enqueue`)
3. ìƒë‹´ì› ê°€ìš© ì„¤ì • (`PUT /counselors/1/availability`)
4. 5ì´ˆ ëŒ€ê¸° (ìë™ ë§¤ì¹­)
5. ê³ ê°: ë§¤ì¹­ ì•Œë¦¼ ìˆ˜ì‹  â†’ LiveKit ì—°ê²° â†’ í†µí™” í™”ë©´ ì „í™˜
6. ìƒë‹´ì›: ë§¤ì¹­ ì•Œë¦¼ ìˆ˜ì‹  â†’ LiveKit ì—°ê²° â†’ í†µí™” í™”ë©´ ì „í™˜

### ì‹œë‚˜ë¦¬ì˜¤ 2: ë¸”ë™ë¦¬ìŠ¤íŠ¸ ìš°ì„  ë§¤ì¹­

1. ì¼ë°˜ ê³ ê° A ëŒ€ê¸°ì—´ ì§„ì…
2. ë¸”ë™ë¦¬ìŠ¤íŠ¸ ê³ ê° B ëŒ€ê¸°ì—´ ì§„ì…
3. ìƒë‹´ì› ê°€ìš© ì„¤ì •
4. **ë¸”ë™ë¦¬ìŠ¤íŠ¸ ê³ ê° Bê°€ ë¨¼ì € ë§¤ì¹­**ë¨ (ìš°ì„ ìˆœìœ„)
5. ë‹¤ìŒ ì‚¬ì´í´ì— ì¼ë°˜ ê³ ê° A ë§¤ì¹­

### ì‹œë‚˜ë¦¬ì˜¤ 3: ì¬ì—°ê²° í…ŒìŠ¤íŠ¸

1. í†µí™” ì¤‘ ë„¤íŠ¸ì›Œí¬ ëŠê¹€
2. LiveKit ìë™ ì¬ì—°ê²° ì‹œë„
3. WebSocket ì¬ì—°ê²° ë¡œì§ ì‘ë™

---

## ğŸ“ í™˜ê²½ë³€ìˆ˜ ìš”ì•½

### ë°±ì—”ë“œ (.env)
```
DB_URL=jdbc:postgresql://localhost:8432/hearo_db?ssl=false
REDIS_HOST=localhost
LIVEKIT_URL=ws://localhost:7880
LIVEKIT_API_KEY=devkey
LIVEKIT_API_SECRET=my_super_long_secret_key_for_ssafy_project_1234556789
SPRING_PROFILES_ACTIVE=dev
```

### í”„ë¡ íŠ¸ì—”ë“œ (.env.local)
```
VITE_API_PROXY_TARGET=http://localhost:8080
VITE_WS_BASE_URL=http://localhost:8080
VITE_LIVEKIT_URL=ws://localhost:8880
```

---

## ğŸš€ ë¹ ë¥¸ ì‹œì‘ (ì˜¬ì¸ì›)

```bash
# 1. ì¸í”„ë¼ ì‹œì‘
cd infra && docker-compose -f docker-compose-infra.yaml up -d

# 2. ë°±ì—”ë“œ ì‹œì‘
cd ../backend && ./gradlew bootRun &

# 3. í”„ë¡ íŠ¸ì—”ë“œ ì‹œì‘
cd ../frontend && npm run dev
```

**í…ŒìŠ¤íŠ¸ URL:**
- í”„ë¡ íŠ¸ì—”ë“œ: http://localhost:5173
- ë°±ì—”ë“œ API: http://localhost:8080
- Swagger: http://localhost:8080/swagger-ui.html

---

**ì‘ì„±ì¼:** 2026-01-30
**ë²„ì „:** v1.0
