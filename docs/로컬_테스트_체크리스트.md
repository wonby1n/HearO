# 로컬 테스트 체크리스트

## ✅ 실행 전 체크리스트

### 1. 인프라 서비스 실행

```bash
cd infra
docker-compose -f docker-compose-infra.yaml up -d
```

확인:
- [ ] PostgreSQL 실행 (포트 8432)
- [ ] Redis 실행 (포트 6379)
- [ ] LiveKit 실행 (포트 7880)

```bash
docker-compose -f docker-compose-infra.yaml ps
```

---

### 2. 백엔드 환경변수 설정

**IntelliJ IDEA에서 설정:**

`Run > Edit Configurations > HearoApplication > Environment Variables`

```
DB_URL=jdbc:postgresql://localhost:8432/hearo_db?ssl=false;
DB_USER=postgres;
DB_PASSWORD=1234;
REDIS_HOST=localhost;
REDIS_PORT=6379;
REDIS_PASSWORD=ssafy_redis_1234!;
LIVEKIT_URL=ws://localhost:7880;
LIVEKIT_API_KEY=devkey;
LIVEKIT_API_SECRET=my_super_long_secret_key_for_ssafy_project_1234556789;
SPRING_PROFILES_ACTIVE=dev
```

또는 **Gradle로 실행:**

```bash
cd backend

# 환경변수와 함께 실행
DB_URL=jdbc:postgresql://localhost:8432/hearo_db?ssl=false \
DB_USER=postgres \
DB_PASSWORD=1234 \
REDIS_HOST=localhost \
REDIS_PORT=6379 \
REDIS_PASSWORD=ssafy_redis_1234! \
LIVEKIT_URL=ws://localhost:7880 \
LIVEKIT_API_KEY=devkey \
LIVEKIT_API_SECRET=my_super_long_secret_key_for_ssafy_project_1234556789 \
SPRING_PROFILES_ACTIVE=dev \
./gradlew bootRun
```

확인:
- [ ] 백엔드 시작 (http://localhost:8080)
- [ ] Swagger UI 접속 (http://localhost:8080/swagger-ui.html)
- [ ] 데이터베이스 연결 확인 (로그에서 "HikariPool-1" 검색)

---

### 3. 프론트엔드 환경변수 설정

`frontend/.env.local` 파일 확인:

```env
VITE_API_PROXY_TARGET=http://localhost:8080
VITE_WS_BASE_URL=http://localhost:8080
VITE_LIVEKIT_URL=ws://localhost:8880
```

확인:
- [ ] `.env.local` 파일 존재
- [ ] `VITE_WS_BASE_URL` 설정됨
- [ ] `VITE_LIVEKIT_URL` 로컬 URL

---

### 4. 프론트엔드 실행

```bash
cd frontend

# STOMP 라이브러리 설치 확인
npm install

# 개발 서버 실행
npm run dev
```

확인:
- [ ] `@stomp/stompjs` 설치됨
- [ ] `sockjs-client` 설치됨
- [ ] 개발 서버 시작 (http://localhost:5173)

---

## 🧪 기능 테스트 체크리스트

### Step 1: 백엔드 API 동작 확인

**Swagger UI에서 테스트:** http://localhost:8080/swagger-ui.html

1. **고객 접수 API**
   ```
   POST /api/v1/registrations
   {
     "customerId": 1,
     "productName": "세탁기",
     "modelName": "WM-2000",
     "symptom": "세탁 중 멈춤",
     "purchaseDate": "2023-01-15",
     "warrantyPeriod": "2026-01-15"
   }
   ```
   - [ ] 200 OK 응답
   - [ ] registrationId 반환됨

2. **대기열 진입 API**
   ```
   POST /api/v1/queue/enqueue
   {
     "customerId": "1"
   }
   ```
   - [ ] 200 OK 응답
   - [ ] 대기열에 추가됨

3. **상담원 가용 상태 설정**
   ```
   PUT /api/v1/counselors/1/availability
   {
     "available": true
   }
   ```
   - [ ] 200 OK 응답

---

### Step 2: WebSocket 연결 확인

**Chrome DevTools > Network > WS 탭**

1. 프론트엔드 대기 화면 접속: http://localhost:5173/client/waiting

2. WebSocket 연결 확인
   - [ ] `ws://localhost:8080/ws/queue/...` 연결됨 (Status: 101 Switching Protocols)
   - [ ] STOMP 프레임 확인:
     ```
     CONNECT
     SUBSCRIBE destination:/topic/queue-rank/1
     ```

3. 콘솔 로그 확인
   - [ ] `[STOMP] 연결 성공` 출력됨

---

### Step 3: 매칭 알림 수신 확인

**5초 대기 후 자동 매칭**

1. 백엔드 로그 확인
   ```
   [MatchingScheduler] 매칭 완료: 고객=1, 상담원=1, 방=room-1-1-abc12345
   [QueueEventPublisher] 고객 매칭 알림 전송
   [QueueEventPublisher] 상담원 매칭 알림 전송
   ```
   - [ ] 매칭 완료 로그 확인

2. 프론트엔드 콘솔 확인
   ```
   [STOMP] 매칭 완료: { status: "MATCHED", roomName: "...", identity: "..." }
   [CallConnection] 매칭 완료, LiveKit 토큰 요청 중...
   ```
   - [ ] 매칭 알림 수신 로그
   - [ ] LiveKit 토큰 요청 로그

3. Network 탭 확인
   - [ ] `POST /api/v1/calls/token` 요청 확인
   - [ ] 200 OK 응답
   - [ ] `{ token: "...", url: "ws://localhost:7880" }` 응답 확인

---

### Step 4: LiveKit 연결 확인

1. 프론트엔드 콘솔 확인
   ```
   [CallConnection] LiveKit 연결 중...
   [LiveKit] 룸 연결 성공: room-1-1-abc12345
   [LiveKit] 마이크 활성화
   [CallConnection] 통화 연결 완료
   ```
   - [ ] LiveKit 연결 성공 로그
   - [ ] 마이크 권한 요청 (브라우저 팝업)
   - [ ] 마이크 활성화 성공

2. 페이지 전환 확인
   - [ ] 자동으로 `/client/call` 페이지로 이동

3. LiveKit 서버 로그 확인
   ```bash
   docker logs livekit-server
   ```
   - [ ] 클라이언트 연결 로그 확인

---

## 🐛 디버깅 체크리스트

### WebSocket 연결 실패 시

- [ ] 백엔드가 실행 중인가?
  ```bash
  curl http://localhost:8080/actuator/health
  ```

- [ ] CORS 설정 확인
  - WebSocketConfig.java의 `setAllowedOriginPatterns("*")` 확인

- [ ] 포트 충돌 확인
  ```bash
  lsof -i :8080
  ```

### 매칭 알림을 받지 못할 때

- [ ] 상담원이 가용 상태인가?
  ```bash
  curl http://localhost:8080/api/v1/counselors/1/availability
  ```

- [ ] 대기열에 고객이 있는가?
  ```bash
  curl http://localhost:8080/api/v1/queue/status
  ```

- [ ] MatchingScheduler가 실행 중인가?
  - 백엔드 로그에서 "매칭 시작" 또는 "매칭 스킵" 확인

### LiveKit 토큰 요청 실패 시

- [ ] LiveKit API Key/Secret 확인
  ```bash
  # 백엔드 로그에서 확인
  grep "LIVEKIT" backend/logs/application.log
  ```

- [ ] LiveKit 서버 실행 확인
  ```bash
  docker ps | grep livekit
  ```

- [ ] LiveKit URL 확인 (`ws://localhost:7880`)

### LiveKit 연결 실패 시

- [ ] 브라우저 콘솔에서 에러 메시지 확인
- [ ] 방화벽 확인 (포트 7880-7882)
- [ ] LiveKit 서버 재시작
  ```bash
  docker-compose -f docker-compose-infra.yaml restart livekit-server
  ```

---

## 📊 성공 기준

### 전체 플로우 성공 조건

1. ✅ 고객 접수 → 대기열 진입
2. ✅ WebSocket (STOMP) 연결 성공
3. ✅ 5초 내 자동 매칭
4. ✅ 매칭 알림 수신 (고객/상담원)
5. ✅ LiveKit 토큰 발급 성공
6. ✅ LiveKit 룸 연결 성공
7. ✅ 마이크 활성화 성공
8. ✅ 통화 화면으로 자동 전환

### 소요 시간

- 매칭 대기: **최대 5초** (MatchingScheduler 주기)
- LiveKit 토큰 요청: **~500ms**
- LiveKit 연결: **~1초**
- 전체 플로우: **~7초 이내**

---

## 🔄 반복 테스트 가이드

### 테스트 초기화

```bash
# 1. 백엔드 재시작 (데이터베이스 초기화)
# application-dev.yaml의 ddl-auto: create 설정으로 자동 초기화

# 2. Redis 초기화
docker exec -it redis redis-cli
> FLUSHALL
> exit

# 3. 프론트엔드 새로고침
# Ctrl + Shift + R (강제 새로고침)
```

### 다음 테스트 준비

1. 새 고객으로 접수 (customerId: 2)
2. 다른 상담원 가용 설정 (counselorId: 2)
3. 동일한 플로우 반복

---

**작성일:** 2026-01-30
**버전:** v1.0
